---
title: '[Web]ロバスト性の高いメトリクス監視ソリューションを設計する（小中規模向け）'
created: 2024-08-28
updated: 2024-08-28
tags:
  - '技術'
  - 'Prometheus'
  - 'Grafana'
  - 'Thanos'
  - 'InfluxDB'
  - 'メトリクス'
  - 'DevOps'
  - 'サーバー監視'
  - 'Web'
  - 'インフラ'
  - 'AWS'
  - 'Docker'
---

## モチベーション

インフラのプロフェッショナルならいざ知らず、スタートアップやインディーデベロッパーにとっては、 Web アプリケーションの開発は実現できても運用や監視、または開発中であってもパフォーマンス改善などに大きな手掛かりとなるメトリクスの収集や可視化はなかなか手が出しにくいものです。

またメトリクス監視というとクラウド基盤(AWS とか)に付帯するリッチなサービスを使うイメージがありますが、それらは大規模なシステムかつ周到な計画のもとでの導入が前提であり、例えばローカル・Docker でサービスを開発している段階では当然ながら利用できません。
そのため開発段階からメトリクスの収集や可視化を行いつつ、本番環境にもスムーズに導入できるようなソリューションが望ましいでしょう。

本記事では Prometheus / Grafana をベースとしたソリューションを検討しますが、これらの導入記事はありふれているものの、Web サービス自体との接続方法やデータ永続化については言及されないことが多いです。
そこで実運用を見据えられるような、ある程度ロバスト性の高いメトリクス監視ソリューションの設計についてここで説明します。

※背景としてオンラインゲームなどのリアルタイム性の高いサービスの経験を反映してますが、それ以外のサービスにも適用可能かと思います。また私はインフラのプロフェッショナルではないため、ベストプラクティスの提供はできないかもしれませんがご容赦ください。

## Prometheus とは

Prometheus （プロメテウス）は、オープンソースのシステム監視およびアラートツールキットです。メトリクスデータを収集し、クエリを実行して可視化するための強力な機能を提供します。

### 主な特徴

- 時系列データベース
- 強力なクエリ言語（PromQL）
- プルモデルによるデータ収集
- アラート機能

## Grafana とは

Grafana （グラファナ）は、オープンソースのデータ可視化ツールです。Prometheus などのデータソースからデータを取得し、美しいダッシュボードを作成することができます。

### 主な特徴

- 多様なデータソースのサポート
- カスタマイズ可能なダッシュボード
- アラート機能

## Thanos とは

Thanos は、Prometheus のデータを長期間保存し、スケーラブルな監視ソリューションを提供するためのツールです。複数の Prometheus インスタンスを統合し、一貫したビューを提供します。

### 主な特徴

- 長期間のデータ保存
- 高可用性
- スケーラビリティ

## 監視ソリューションの設計

### 1. Prometheus のセットアップ

まず、Prometheus をセットアップします。Prometheus の設定ファイルを作成し、ターゲットのエンドポイントを指定します。
