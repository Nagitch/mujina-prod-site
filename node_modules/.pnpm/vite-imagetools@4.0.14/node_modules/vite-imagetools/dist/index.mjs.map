{"version":3,"file":"index.mjs","sources":["../src/index.ts"],"sourcesContent":["import { Plugin, ResolvedConfig } from 'vite'\nimport {\n  parseURL,\n  loadImage,\n  builtins,\n  resolveConfigs,\n  applyTransforms,\n  generateTransforms,\n  getMetadata,\n  generateImageID,\n  builtinOutputFormats,\n  urlFormat,\n  extractEntries\n} from 'imagetools-core'\nimport { basename, extname, posix } from 'path'\nimport { createFilter, dataToEsm } from '@rollup/pluginutils'\nimport { VitePluginOptions } from './types'\n\nconst defaultOptions: VitePluginOptions = {\n  include: [\n    '**/*.{heic,heif,avif,jpeg,jpg,png,tiff,webp,gif}',\n    '**/*.{heic,heif,avif,jpeg,jpg,png,tiff,webp,gif}?*'\n  ],\n  exclude: 'public/**/*',\n  silent: false,\n  removeMetadata: true\n}\n\nexport * from 'imagetools-core';\n\nexport function imagetools(userOptions: Partial<VitePluginOptions> = {}): Plugin {\n  const pluginOptions: VitePluginOptions = { ...defaultOptions, ...userOptions }\n\n  const filter = createFilter(pluginOptions.include, pluginOptions.exclude)\n\n  const transformFactories = pluginOptions.extendTransforms ? pluginOptions.extendTransforms(builtins) : builtins\n\n  const outputFormats = pluginOptions.extendOutputFormats\n    ? pluginOptions.extendOutputFormats(builtinOutputFormats)\n    : builtinOutputFormats\n\n  let viteConfig: ResolvedConfig\n\n  const generatedImages = new Map()\n\n  return {\n    name: 'imagetools',\n    enforce: 'pre',\n    configResolved(cfg) {\n      viteConfig = cfg\n    },\n    async load(id) {\n      if (!filter(id)) return null\n\n      const srcURL = parseURL(id)\n\n      let directives = srcURL.searchParams\n\n      if (typeof pluginOptions.defaultDirectives === 'function') {\n        directives = new URLSearchParams([...pluginOptions.defaultDirectives(srcURL), ...srcURL.searchParams])\n      } else if (pluginOptions.defaultDirectives) {\n        directives = new URLSearchParams([...pluginOptions.defaultDirectives, ...srcURL.searchParams])\n      }\n\n      if (!directives.toString()) return null\n\n      const parameters = extractEntries(directives)\n      const imageConfigs =\n        pluginOptions.resolveConfigs?.(parameters, outputFormats) ?? resolveConfigs(parameters, outputFormats)\n\n      const img = loadImage(decodeURIComponent(srcURL.pathname))\n\n      const outputMetadatas = []\n\n      for (const config of imageConfigs) {\n        const id = generateImageID(srcURL, config)\n\n        const { transforms } = generateTransforms(config, transformFactories)\n        const { image, metadata } = await applyTransforms(transforms, img.clone(), pluginOptions.removeMetadata)\n\n        generatedImages.set(id, image)\n\n        if (!this.meta.watchMode) {\n          const fileName = basename(srcURL.pathname, extname(srcURL.pathname)) + `.${metadata.format}`\n\n          const fileHandle = this.emitFile({\n            name: fileName,\n            source: await image.toBuffer(),\n            type: 'asset'\n          })\n\n          metadata.src = `__VITE_ASSET__${fileHandle}__`\n        } else {\n          metadata.src = posix.join('/@imagetools', id)\n        }\n\n        metadata.image = image\n\n        outputMetadatas.push(metadata)\n      }\n\n      let outputFormat = urlFormat()\n\n      for (const [key, format] of Object.entries(outputFormats)) {\n        if (directives.has(key)) {\n          const params = directives\n            .get(key)\n            ?.split(';')\n            .filter((v: string) => !!v)\n          outputFormat = format(params?.length ? params : undefined)\n          break\n        }\n      }\n\n      return dataToEsm(outputFormat(outputMetadatas), {\n        namedExports: viteConfig.json?.namedExports ?? true,\n        compact: !!viteConfig.build.minify ?? false,\n        preferConst: true\n      })\n    },\n\n    configureServer(server) {\n      server.middlewares.use((req, res, next) => {\n        if (req.url?.startsWith('/@imagetools/')) {\n          const [, id] = req.url.split('/@imagetools/')\n\n          const image = generatedImages.get(id)\n\n          if (!image)\n            throw new Error(`vite-imagetools cannot find image with id \"${id}\" this is likely an internal error`)\n\n          if (pluginOptions.removeMetadata === false) {\n            image.withMetadata()\n          }\n\n          res.setHeader('Content-Type', `image/${getMetadata(image, 'format')}`)\n          res.setHeader('Cache-Control', 'max-age=360000')\n          return image.clone().pipe(res)\n        }\n\n        next()\n      })\n    }\n  }\n}\n"],"names":[],"mappings":"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"}